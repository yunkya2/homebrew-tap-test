name: Test Brew Formula

on:
  push:
    paths:
      - 'Formula/**'
  pull_request:
    paths:
      - 'Formula/**'

jobs:
  test-install:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Tap the repository
        run: |
          brew tap yunkya2/tap-test

      - name: Test formula syntax
        run: |
          brew audit --strict elf2x68k

      - name: Install the formula with verbose output and error handling
        run: |
          set +e  # Continue on error
          brew install --verbose --build-from-source elf2x68k
          INSTALL_EXIT_CODE=$?
          echo "Install exit code: $INSTALL_EXIT_CODE"

          # Check if the installation actually succeeded
          if brew list elf2x68k > /dev/null 2>&1; then
            echo "‚úÖ Formula is successfully installed"
            ls -la $(brew --prefix)/Cellar/elf2x68k/
          else
            echo "‚ùå Formula installation failed"
            exit 1
          fi
          
          # If install exit code was non-zero but package exists, investigate
          if [ $INSTALL_EXIT_CODE -ne 0 ]; then
            echo "‚ö†Ô∏è  Installation completed with warnings or non-fatal errors"
            echo "Checking brew doctor..."
            brew doctor || echo "brew doctor found issues"
          fi

      - name: Test the installation
        run: |
          echo "Running formula tests..."
          brew test elf2x68k || echo "Test failed or no test defined"
          
      - name: Verify installation contents
        run: |
          echo "Checking installed files..."
          brew list elf2x68k | head -20
          echo "Total files: $(brew list elf2x68k | wc -l)"
          
          echo "Checking executables..."
          if [ -f "$(brew --prefix)/bin/m68k-xelf-gcc" ]; then
            echo "‚úÖ m68k-xelf-gcc found"
            $(brew --prefix)/bin/m68k-xelf-gcc --version || echo "Version check failed"
          else
            echo "‚ùå m68k-xelf-gcc not found"
          fi

      - name: Final status check
        run: |
          echo "Final verification..."
          brew info elf2x68k
          echo "Installation completed successfully! üéâ"
